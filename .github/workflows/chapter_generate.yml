name: Book Chapter Generator

on:
  workflow_dispatch:
    inputs:
      book:
        description: "Book ID (e.g. 01)"
        required: true
        default: "01"
      chapter:
        description: "Chapter number (e.g. 03)"
        required: true
      length:
        description: "Draft length (short|medium|long)"
        required: false
        default: "medium"
      tone:
        description: "Tone (cinematic|investigative|raw|poised, etc.)"
        required: false
        default: "cinematic"
      model:
        description: "OpenAI model (e.g. gpt-4.1, gpt-4.1-mini, gpt-5.1)"
        required: false
        default: "gpt-4.1"

jobs:
  generate-chapter:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai

      - name: Run chapter generator
        run: |
          python scripts/book_generate.py \
            --book "${{ github.event.inputs.book }}" \
            --chapter "${{ github.event.inputs.chapter }}" \
            --length "${{ github.event.inputs.length }}" \
            --tone "${{ github.event.inputs.tone }}" \
            --model "${{ github.event.inputs.model }}"

      - name: Show changed files
        run: |
          echo "Changed files:"
          git status -sb
          git diff || true
